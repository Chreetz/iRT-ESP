var ntpSeconds,ajaxobj,myespcontent,version="",websock=null,wsUri="ws://"+window.location.host+"/ws",custom_config={},xDown=null,yDown=null,file={},backupstarted=!1,updateurl="",updateurl_dev="",use_beta_firmware=!1,formData=new FormData,nextIsNotJson=!1,config={};function deviceTime(){var e=new Date(0);e.setUTCSeconds(ntpSeconds),document.getElementById("utc").innerHTML=e.toUTCString().slice(0,-3)}function handleNTPON(){document.getElementById("forcentp").style.display="block"}function handleNTPOFF(){document.getElementById("forcentp").style.display="none"}function listntp(){websock.send('{"command":"gettime"}'),document.getElementById("ntpserver").value=config.ntp.server,document.getElementById("interval").value=config.ntp.interval,document.getElementById("timezone").value=config.ntp.timezone,config.ntp.enabled?($('input[name="ntpenabled"][value="1"]').prop("checked",!0),handleNTPON()):handleNTPOFF(),browserTime(),deviceTime()}function home(){window.location="/"}function restart_alert(){$("#commit").fadeOut(200,function(){$(this).css("background","gold").fadeIn(1e3)}),document.getElementById("commit").innerHTML="<h6>Settings have changed. It's recommended to reboot the system. Click here to restart.</h6>",$("#commit").click(function(){return $("#reboot").modal("show"),!1})}function saveconfig(){websock.send(JSON.stringify(config)),restart_alert()}function custom_saveconfig(){websock.send(JSON.stringify(custom_config)),restart_alert()}function saventp(){config.ntp.server=document.getElementById("ntpserver").value,config.ntp.interval=parseInt(document.getElementById("interval").value),config.ntp.timezone=parseInt(document.getElementById("timezone").value),config.ntp.enabled=!1,1===parseInt($('input[name="ntpenabled"]:checked').val())&&(config.ntp.enabled=!0),saveconfig()}function forcentp(){websock.send('{"command":"forcentp"}')}function savegeneral(){var e=document.getElementById("adminpwd").value;null!==e&&""!==e?(config.general.password=e,config.general.hostname=document.getElementById("hostname").value,config.general.serial=!1,1===parseInt($('input[name="serialenabled"]:checked').val())&&(config.general.serial=!0),config.general.log_events=!1,1===parseInt($('input[name="logeventsenabled"]:checked').val())&&(config.general.log_events=!0),config.general.log_ip=document.getElementById("log_ip").value,saveconfig()):alert("Administrator password cannot be empty")}function savemqtt(){config.mqtt.enabled=!1,1===parseInt($('input[name="mqttenabled"]:checked').val())&&(config.mqtt.enabled=!0),config.mqtt.heartbeat=!1,1===parseInt($('input[name="mqttheartbeat"]:checked').val())&&(config.mqtt.heartbeat=!0),config.mqtt.retain=!1,1===parseInt($('input[name="mqttretain"]:checked').val())&&(config.mqtt.retain=!0),config.mqtt.ip=document.getElementById("mqttip").value,config.mqtt.port=parseInt(document.getElementById("mqttport").value),config.mqtt.qos=parseInt(document.getElementById("mqttqos").value),config.mqtt.keepalive=parseInt(document.getElementById("mqttkeepalive").value),config.mqtt.base=document.getElementById("mqttbase").value,config.mqtt.user=document.getElementById("mqttuser").value,config.mqtt.password=document.getElementById("mqttpwd").value,saveconfig()}function savenetwork(){var e=0;if("none"===document.getElementById("inputtohide").style.display){var t=document.getElementById("ssid");config.network.ssid=t.options[t.selectedIndex].value}else config.network.ssid=document.getElementById("inputtohide").value;document.getElementById("wmodeap").checked&&(e=1),config.network.wmode=e,config.network.password=document.getElementById("wifipass").value,config.network.staticip=document.getElementById("staticip").value,config.network.gatewayip=document.getElementById("gatewayip").value,config.network.nmask=document.getElementById("nmask").value,config.network.dnsip=document.getElementById("dnsip").value,saveconfig()}function inProgress(s){$("body").load("myesp.html #progresscontent",function(e,t,n){if("success"===t){$(".progress").css("height","40"),$(".progress").css("font-size","xx-large");var o=0,a=setInterval(function(){if($(".progress-bar").css("width",o+"%").attr("aria-valuenow",o).html(o+"%"),105===(o+=5)){clearInterval(a);var e=document.createElement("a");e.href="http://"+config.general.hostname+".local",e.innerText="Re-connect...",document.getElementById("reconnect").appendChild(e),document.getElementById("reconnect").style.display="block",document.getElementById("updateprog").className="progress-bar progress-bar-success",document.getElementById("updateprog").innerHTML="Completed"}},500);switch(s){case"upload":$.ajax({url:"/update",type:"POST",data:formData,processData:!1,contentType:!1});break;case"destroy":websock.send('{"command":"destroy"}');break;case"restart":websock.send('{"command":"restart"}')}}}).hide().fadeIn()}function inProgressUpload(){$("body").load("myesp.html #progressupload",function(e,t,n){if("success"===t){$(".progress").css("height","40"),$(".progress").css("font-size","xx-large");var o=0,a=setInterval(function(){$(".progress-bar").css("width",o+"%").attr("aria-valuenow",o).html(o+"%"),101===(o+=1)&&(clearInterval(a),document.getElementById("updateprog").className="progress-bar progress-bar-success",document.getElementById("updateprog").innerHTML="Completed")},500);$.ajax({url:"/update",type:"POST",data:formData,processData:!1,contentType:!1})}}).hide().fadeIn()}function handleSTA(){document.getElementById("scanb").style.display="block",document.getElementById("hideclient").style.display="block"}function handleAP(){document.getElementById("ssid").style.display="none",document.getElementById("scanb").style.display="none",document.getElementById("hideclient").style.display="none",document.getElementById("inputtohide").style.display="block"}function listnetwork(){document.getElementById("inputtohide").value=config.network.ssid,document.getElementById("wifipass").value=config.network.password,1===config.network.wmode?(document.getElementById("wmodeap").checked=!0,handleAP()):(document.getElementById("wmodesta").checked=!0,handleSTA()),document.getElementById("staticip").value=config.network.staticip,document.getElementById("gatewayip").value=config.network.gatewayip,document.getElementById("nmask").value=config.network.nmask,document.getElementById("dnsip").value=config.network.dnsip}function listgeneral(){document.getElementById("adminpwd").value=config.general.password,document.getElementById("hostname").value=config.general.hostname,config.general.serial&&$('input[name="serialenabled"][value="1"]').prop("checked",!0),config.general.log_events&&$('input[name="logeventsenabled"][value="1"]').prop("checked",!0),document.getElementById("log_ip").value=config.general.log_ip}function listmqtt(){config.mqtt.enabled&&$('input[name="mqttenabled"][value="1"]').prop("checked",!0),config.mqtt.heartbeat&&$('input[name="mqttheartbeat"][value="1"]').prop("checked",!0),config.mqtt.retain&&$('input[name="mqttretain"][value="1"]').prop("checked",!0),document.getElementById("mqttip").value=config.mqtt.ip,document.getElementById("mqttport").value=config.mqtt.port,document.getElementById("mqttqos").value=config.mqtt.qos,document.getElementById("mqttkeepalive").value=config.mqtt.keepalive,document.getElementById("mqttbase").value=config.mqtt.base,document.getElementById("mqttuser").value=config.mqtt.user,document.getElementById("mqttpwd").value=config.mqtt.password}function listBSSID(){var e=document.getElementById("ssid");document.getElementById("wifibssid").value=e.options[e.selectedIndex].bssidvalue}function listSSID(e){for(var t=document.getElementById("ssid"),n=0;n<e.list.length;n++){var o=parseInt(e.list[n].rssi),a=Math.min(Math.max(2*(o+100),0),100),s=document.createElement("option");s.value=e.list[n].ssid,s.bssidvalue=e.list[n].bssid,s.innerHTML="BSSID: "+e.list[n].bssid+", Signal Strength: %"+a+", Network: "+e.list[n].ssid,t.appendChild(s)}document.getElementById("scanb").innerHTML="Re-scan...",listBSSID()}function scanWifi(){websock.send('{"command":"scan"}'),document.getElementById("scanb").innerHTML="...",document.getElementById("inputtohide").style.display="none";var e=document.getElementById("ssid");for(e.style.display="inline";e.hasChildNodes();)e.removeChild(e.lastChild)}function isVisible(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)}function colorStatusbar(e){var t=e.style.width.slice(0,-1);50<t?e.className="progress-bar progress-bar-success":25<t?e.className="progress-bar progress-bar-warning":e.class="progress-bar progress-bar-danger"}function listStats(){document.getElementById("uptime").innerHTML=ajaxobj.uptime,document.getElementById("heap").innerHTML=ajaxobj.heap+" bytes",document.getElementById("heap").style.width=100*ajaxobj.heap/ajaxobj.initheap+"%",colorStatusbar(document.getElementById("heap")),document.getElementById("flash").innerHTML=ajaxobj.availsize+" KB",document.getElementById("flash").style.width=100*ajaxobj.availsize/(ajaxobj.availsize+ajaxobj.sketchsize)+"%",colorStatusbar(document.getElementById("flash")),document.getElementById("spiffs").innerHTML=ajaxobj.availspiffs+" KB",document.getElementById("spiffs").style.width=100*ajaxobj.availspiffs/ajaxobj.spiffssize+"%",colorStatusbar(document.getElementById("spiffs")),document.getElementById("ssidstat").innerHTML=ajaxobj.ssid,document.getElementById("ip").innerHTML=ajaxobj.ip,document.getElementById("mac").innerHTML=ajaxobj.mac,document.getElementById("signalstr").innerHTML=ajaxobj.signalstr+" %",document.getElementById("systemload").innerHTML=ajaxobj.systemload+" %",ajaxobj.mqttconnected?(document.getElementById("mqttconnected").innerHTML="MQTT is connected",document.getElementById("mqttconnected").className="label label-success"):(document.getElementById("mqttconnected").innerHTML="MQTT is not connected",document.getElementById("mqttconnected").className="label label-danger"),ajaxobj.mqttheartbeat?(document.getElementById("mqttheartbeat").innerHTML="MQTT hearbeat is enabled",document.getElementById("mqttheartbeat").className="label label-success"):(document.getElementById("mqttheartbeat").innerHTML="MQTT hearbeat is disabled",document.getElementById("mqttheartbeat").className="label label-primary")}function getContent(a){$("#dismiss").click(),$(".overlay").fadeOut().promise().done(function(){var e=$(a).html();$("#ajaxcontent").html(e).promise().done(function(){switch(a){case"#statuscontent":listStats();break;case"#backupcontent":break;case"#ntpcontent":listntp();break;case"#mqttcontent":listmqtt();break;case"#generalcontent":listgeneral();break;case"#networkcontent":listnetwork();break;case"#customcontent":listcustom();break;case"#custom_statuscontent":var e="version "+ajaxobj.version;$("#mainver").text(e),$("#customname").text(ajaxobj.customname);var t,n=" "+ajaxobj.customname;if($("#customname2").text(n),0===config.network.wmode){t=document.getElementById("helpurl");var o=ajaxobj.appurl+"/wiki";t.setAttribute("href",o),document.getElementById("helpurl").style.display="block"}else document.getElementById("helpurl").style.display="none";(t=document.getElementById("appurl")).setAttribute("href",ajaxobj.appurl),$("#appurl2").text(ajaxobj.appurl),updateurl=ajaxobj.updateurl,updateurl_dev=ajaxobj.updateurl_dev,listCustomStats()}$('[data-toggle="popover"]').popover({container:"body"}),$(this).hide().fadeIn()})})}function backupset(){var e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(config,null,2)),t=document.getElementById("downloadSet");t.setAttribute("href",e),t.setAttribute("download","system_config.json"),t.click()}function backupCustomSet(){var e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(custom_config,null,2)),t=document.getElementById("downloadCustomSet");t.setAttribute("href",e),t.setAttribute("download","custom_config.json"),t.click()}function restoreSet(){var e=document.getElementById("restoreSet"),t=new FileReader;"files"in e&&(0===e.files.length?alert("You did not select file to restore!"):(t.onload=function(){var e;try{e=JSON.parse(t.result)}catch(e){return void alert("Not a valid backup file!")}"configfile"===e.command&&(confirm("System Config file seems to be valid, do you wish to continue?")&&(config=e,saveconfig()))},t.readAsText(e.files[0])))}function restoreCustomSet(){var e=document.getElementById("restoreCustomSet"),t=new FileReader;"files"in e&&(0===e.files.length?alert("You did not select file to restore!"):(t.onload=function(){var e;try{e=JSON.parse(t.result)}catch(e){return void alert("Not a valid backup file!")}"custom_configfile"===e.command&&(confirm("Custom Config file seems to be valid, do you wish to continue?")&&(custom_config=e,custom_saveconfig()))},t.readAsText(e.files[0])))}function twoDigits(e){return e<10?"0"+e:e}function socketMessageListener(e){var t=JSON.parse(e.data);if(t.hasOwnProperty("command"))switch(t.command){case"status":ajaxobj=t,getContent("#statuscontent");break;case"custom_settings":ajaxobj=t;break;case"custom_status":ajaxobj=t,getContent("#custom_statuscontent");break;case"gettime":ntpSeconds=t.epoch,deviceTime();break;case"ssidlist":listSSID(t);break;case"configfile":config=t;break;case"custom_configfile":custom_config=t}}function compareDestroy(){config.general.hostname===document.getElementById("compare").value?$("#destroybtn").prop("disabled",!1):$("#destroybtn").prop("disabled",!0)}function destroy(){inProgress("destroy")}function restart(){inProgress("restart")}function handleTouchStart(e){xDown=e.touches[0].clientX,yDown=e.touches[0].clientY}function handleTouchMove(e){if(xDown&&yDown){var t=e.touches[0].clientX,n=e.touches[0].clientY,o=xDown-t,a=yDown-n;Math.abs(o)>Math.abs(a)&&(0<o?$("#dismiss").click():$("#sidebarCollapse").click()),yDown=xDown=null}}function logout(){return jQuery.ajax({type:"GET",url:"/login",async:!1,username:"logmeout",password:"logmeout"}).done(function(){}).fail(function(){document.location="index.html"}),!1}function connectWS(){"https:"===window.location.protocol?wsUri="wss://"+window.location.host+"/ws":"file:"===window.location.protocol&&(wsUri="ws://localhost/ws"),(websock=new WebSocket(wsUri)).addEventListener("message",socketMessageListener),websock.onopen=function(e){websock.send('{"command":"getconf"}'),websock.send('{"command":"custom_status"}')}}function upload(){formData.append("bin",$("#binform")[0].files[0]),inProgressUpload()}function login(){if("neo"===document.getElementById("password").value)$("#signin").modal("hide"),connectWS();else{var e=document.getElementById("password").value,t=new XMLHttpRequest;t.open("get","/login",!0,"admin",e),t.onload=function(e){4===t.readyState&&(200===t.status?($("#signin").modal("hide"),connectWS()):alert("Incorrect password!"))},t.send(null)}}function getfirmware(){document.getElementById("updateb").innerHTML=use_beta_firmware?(use_beta_firmware=!1,"Switch to Development build"):(use_beta_firmware=!0,"Switch to Stable release"),getLatestReleaseInfo()}function getLatestReleaseInfo(){if(use_beta_firmware)var e=updateurl_dev;else e=updateurl;$.getJSON(e).done(function(e){for(var t=e.assets[0],n=0,o=0;o<e.assets.length;o++)n+=e.assets[o].download_count;var a,s=new Date-new Date(e.published_at);a=s<864e5?(s/36e5).toFixed(1)+" hours ago":(s/864e5).toFixed(1)+" days ago";var c=e.name+" was updated "+a+" and downloaded "+n.toLocaleString()+" times.";$("#downloadupdate").attr("href",t.browser_download_url),$("#releasehead").text(c),$("#releasebody").text(e.body),$("#releaseinfo").fadeIn("slow")}).error(function(){$("#onlineupdate").html("<h5>Couldn't get release details. Make sure there is an Internet connection.</h5>")})}function allowUpload(){$("#upbtn").prop("disabled",!1)}function start(){(myespcontent=document.createElement("div")).id="mastercontent",myespcontent.style.display="none",document.body.appendChild(myespcontent),$("#signin").on("shown.bs.modal",function(){$("#password").focus().select()}),$("#mastercontent").load("myesp.html",function(e,t,n){"success"===t&&($("#signin").modal({backdrop:"static",keyboard:!1}),$('[data-toggle="popover"]').popover({container:"body"}))})}function refreshCustomStatus(){websock.send('{"command":"custom_status"}')}function refreshStatus(){websock.send('{"command":"status"}')}$("#dismiss, .overlay").on("click",function(){$("#sidebar").removeClass("active"),$(".overlay").fadeOut()}),$("#sidebarCollapse").on("click",function(){$("#sidebar").addClass("active"),$(".overlay").fadeIn(),$(".collapse.in").toggleClass("in"),$("a[aria-expanded=true]").attr("aria-expanded","false")}),$("#custom_status").click(function(){return websock.send('{"command":"custom_status"}'),!1}),$("#status").click(function(){return websock.send('{"command":"status"}'),!1}),$("#custom").click(function(){return getContent("#customcontent"),!1}),$("#network").on("click",function(){return getContent("#networkcontent"),!1}),$("#general").click(function(){return getContent("#generalcontent"),!1}),$("#mqtt").click(function(){return getContent("#mqttcontent"),!1}),$("#ntp").click(function(){return getContent("#ntpcontent"),!1}),$("#backup").click(function(){return getContent("#backupcontent"),!1}),$("#reset").click(function(){return $("#destroy").modal("show"),!1}),$("#restart").click(function(){return $("#reboot").modal("show"),!1}),$(".noimp").on("click",function(){$("#noimp").modal("show")}),$("#update").on("shown.bs.modal",function(e){getfirmware()}),document.addEventListener("touchstart",handleTouchStart,!1),document.addEventListener("touchmove",handleTouchMove,!1);custom_config={command:"custom_configfile",settings:{led:!0,led_gpio:2,dallas_gpio:14,dallas_parasite:!1,listen_mode:!1,shower_timer:!1,shower_alert:!1,publish_time:10,tx_mode:1}};function listcustom(){document.getElementById("led_gpio").value=custom_config.settings.led_gpio,document.getElementById("dallas_gpio").value=custom_config.settings.dallas_gpio,document.getElementById("publish_time").value=custom_config.settings.publish_time,document.getElementById("tx_mode").value=custom_config.settings.tx_mode,custom_config.settings.led&&$('input[name="led"][value="1"]').prop("checked",!0),custom_config.settings.dallas_parasite&&$('input[name="dallas_parasite"][value="1"]').prop("checked",!0),custom_config.settings.listen_mode&&$('input[name="listen_mode"][value="1"]').prop("checked",!0),custom_config.settings.shower_timer&&$('input[name="shower_timer"][value="1"]').prop("checked",!0),custom_config.settings.shower_alert&&$('input[name="shower_alert"][value="1"]').prop("checked",!0)}function savecustom(){custom_config.settings.led_gpio=parseInt(document.getElementById("led_gpio").value),custom_config.settings.dallas_gpio=parseInt(document.getElementById("dallas_gpio").value),custom_config.settings.dallas_parasite=!1,1===parseInt($('input[name="dallas_parasite"]:checked').val())&&(custom_config.settings.dallas_parasite=!0),custom_config.settings.listen_mode=!1,1===parseInt($('input[name="listen_mode"]:checked').val())&&(custom_config.settings.listen_mode=!0),custom_config.settings.shower_timer=!1,1===parseInt($('input[name="shower_timer"]:checked').val())&&(custom_config.settings.shower_timer=!0),custom_config.settings.shower_alert=!1,1===parseInt($('input[name="shower_alert"]:checked').val())&&(custom_config.settings.shower_alert=!0),custom_config.settings.led=!1,1===parseInt($('input[name="led"]:checked').val())&&(custom_config.settings.led=!0),custom_config.settings.publish_time=parseInt(document.getElementById("publish_time").value),custom_config.settings.tx_mode=parseInt(document.getElementById("tx_mode").value),custom_saveconfig()}function listCustomStats(){if(document.getElementById("msg").innerHTML=ajaxobj.emsbus.msg,!ajaxobj.emsbus.ok)return document.getElementById("msg").className="alert alert-danger",document.getElementById("devicesshow").style.display="none",document.getElementById("thermostat_show").style.display="none",document.getElementById("boiler_show").style.display="none",document.getElementById("sm_show").style.display="none",void(document.getElementById("hp_show").style.display="none");document.getElementById("msg").className="alert alert-success";document.getElementById("devices");var e=ajaxobj.emsbus.devices;document.getElementById("devicesshow").style.display="block";for(var t=0;t<e.length;t++){document.createElement("li");var n=e[t].type;"Boiler"===n?"list-group-item-success":"Thermostat"===n?"list-group-item-info":"Solar Module"===n?"list-group-item-warning":"Heat Pump"===n&&"list-group-item-success"}ajaxobj.boiler.ok?(document.getElementById("boiler_show").style.display="block",document.getElementById("bm").innerHTML=ajaxobj.boiler.bm,document.getElementById("b1").innerHTML=ajaxobj.boiler.b1,document.getElementById("b2").innerHTML=ajaxobj.boiler.b2,document.getElementById("b3").innerHTML=ajaxobj.boiler.b3+" &#37;",document.getElementById("b4").innerHTML=ajaxobj.boiler.b4+" &#8451;",document.getElementById("b5").innerHTML=ajaxobj.boiler.b5+" &#8451;",document.getElementById("b6").innerHTML=ajaxobj.boiler.b6+" &#8451;",document.getElementById("b7").innerHTML=ajaxobj.boiler.b7+" &#8451;",document.getElementById("b8").innerHTML=ajaxobj.boiler.b8+" &#8451;"):document.getElementById("boiler_show").style.display="none",ajaxobj.thermostat.ok?(document.getElementById("thermostat_show").style.display="block",document.getElementById("tm").innerHTML=ajaxobj.thermostat.tm,document.getElementById("ts").innerHTML=ajaxobj.thermostat.ts+" &#8451;",document.getElementById("tc").innerHTML=ajaxobj.thermostat.tc+" &#8451;",document.getElementById("tmode").innerHTML=ajaxobj.thermostat.tmode):document.getElementById("thermostat_show").style.display="none",ajaxobj.sm.ok?(document.getElementById("sm_show").style.display="block",document.getElementById("sm").innerHTML=ajaxobj.sm.sm,document.getElementById("sm1").innerHTML=ajaxobj.sm.sm1+" &#8451;",document.getElementById("sm2").innerHTML=ajaxobj.sm.sm2+" &#8451;",document.getElementById("sm3").innerHTML=ajaxobj.sm.sm3+" &#37;",document.getElementById("sm4").innerHTML=ajaxobj.sm.sm4,document.getElementById("sm5").innerHTML=ajaxobj.sm.sm5+" Wh",document.getElementById("sm6").innerHTML=ajaxobj.sm.sm6+" Wh",document.getElementById("sm7").innerHTML=ajaxobj.sm.sm7+" KWh"):document.getElementById("sm_show").style.display="none",ajaxobj.hp.ok?(document.getElementById("hp_show").style.display="block",document.getElementById("hm").innerHTML=ajaxobj.hp.hm,document.getElementById("hp1").innerHTML=ajaxobj.hp.hp1+" &#37;",document.getElementById("hp2").innerHTML=ajaxobj.hp.hp2+" &#37;"):document.getElementById("hp_show").style.display="none"}